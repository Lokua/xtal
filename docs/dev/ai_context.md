# Xtal AI Context (Minimal)

Read `README.md` first.

## Hard Rules (Always Follow)

- Most work is in WGSL + YAML control scripts under `sketches/src/sketches/`.
- `ControlHub` is source of truth for runtime params.
- Use beats, not wall time:
  - `params.set("a3", hub.animation.beats())` in Rust update path.
  - In WGSL, treat `a.z` as beat time.
- YAML and WGSL hot-reload. Rust code changes require app restart.
- Do not edit `*_controls.json` in storage; they are autogenerated.
- Keep code style strict:
  - No column alignment.
  - Keep lines below or equal to 80 chars in all languages.
  - Group Rust imports: std, external, internal.
  - Prefer explicit control flow over clever abstractions.
  - Put comments above code, not end-of-line.
  - Rust ordering:
    1. Imports/uses (grouped and ordered)
    2. Constants and static definitions
    3. Public type aliases
    4. Main public struct(s) and their implementations
    5. Public API functions
    6. Private implementation details
  - Use "main up top; implementation details below" pattern in wgsl, e.g. vertex
    and fragment shaders are above helpers like and `fbm`

## Core Workflow

- Fast verify loop:
  - `cargo check -p sketches` (not needed when working solely on wgsl or yaml
    since we have hot reload)
- If touching UI:
  - `npm --prefix xtal-ui run build`
- If behavior is wrong:
  - Check YAML/schema issues before changing runtime logic.
- For control scripting details:
  - `docs/control_script_reference.md`

## Shader + YAML Rules

- Bind controls with `var` (`a1`, `b3`, etc.).
- Use separators and section comments in YAML. Titles should be short like
  `color`, `geometry`. Comments should be header style comments above the
  separator control as follows:

```yaml
# ------------------------------------------------------------------------------
#  Like This
# ------------------------------------------------------------------------------
```

- For periodic motion, use YAML animation types (`random_slewed`, `triangle`,
  `round_robin`) instead of deriving timing in WGSL.
- For rate-like controls, use tempo-friendly `step` values (`0.25` or `0.125`).
- Prefer validation at parse/schema boundaries when possible.
- UI controls / uniforms should be reserved for parameters that are likely to be
  performed, e.g. `wave_amp`, but not granular settings like
  `max_raymarch_distance` which are better suited as constants at the top of the
  shader.
- Most Xtal shaders use NDC space; unlike other shaders, so keep that in mind
  when porting.

## New Auto Sketch Checklist

- Copy template files from `sketches/src/sketches/templates/` to
  `sketches/src/sketches/auto/<name>.{rs,yaml,wgsl}`.
- Update `<name>` wiring in:
  - `sketches/src/sketches/auto/mod.rs`
  - `sketches/src/sketches/mod.rs`
  - `sketches/src/main.rs` `register!(...)`
- In sketch Rust file:
  - Set `SKETCH_CONFIG.name` and `display_name`.
  - Rename sketch struct type.
  - Point `ControlHub::from_path(...)` to `<name>.yaml`.
  - Point GPU shader path to `<name>.wgsl`.
- Verify:
  - `cargo check -p sketches` (unless we're just working on wgsl, then that's
    pointless as they hot reload and I'll see errors immediately and provide
    feedback)
